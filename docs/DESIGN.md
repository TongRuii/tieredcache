# TieredCache 设计文档

## 1. 概述

TieredCache 是一个基于 Spring Boot 的分层缓存插件，采用本地缓存（L1）+ 远程缓存（L2）的两级缓存架构。它提供了高性能、高可用性和灵活配置的缓存解决方案，适用于各种规模的 Spring Boot 应用。

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                        │
├─────────────────────────────────────────────────────────────┤
│                   Annotation Layer                          │
│  @TieredCache  @LocalCache  @RemoteCache  @CacheEvict       │
├─────────────────────────────────────────────────────────────┤
│                   Management Layer                          │
│              TieredCacheManager                             │
├─────────────────────────────────────────────────────────────┤
│                   Strategy Layer                            │
│   LOCAL_FIRST   REMOTE_FIRST   LOCAL_ONLY   REMOTE_ONLY     │
├─────────────────────────────────────────────────────────────┤
│                Infrastructure Layer                         │
│      Local Cache       │      Remote Cache                  │
│   Caffeine/Guava   │   Redis/Hazelcast                      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件

#### 2.2.1 缓存管理器 (TieredCacheManager)
负责协调本地缓存和远程缓存的操作，实现各种缓存策略。

#### 2.2.2 缓存切面 (CacheAspect)
通过 AOP 技术拦截带有缓存注解的方法，实现缓存的自动管理。

#### 2.2.3 缓存键生成器 (CacheKeyGenerator)
根据方法签名和参数生成唯一的缓存键。

#### 2.2.4 缓存同步管理器 (CacheSyncManager)
负责在分布式环境中同步缓存更新。

#### 2.2.5 监控指标 (CacheMetrics)
收集和报告缓存性能指标。

## 3. 核心功能

### 3.1 缓存策略

#### 3.1.1 LOCAL_FIRST (本地优先)
1. 首先查询本地缓存
2. 如果本地缓存未命中，查询远程缓存
3. 如果远程缓存命中，异步更新本地缓存
4. 如果两级缓存都未命中，执行原方法并将结果写入两级缓存

#### 3.1.2 REMOTE_FIRST (远程优先)
1. 首先查询远程缓存
2. 如果远程缓存未命中，查询本地缓存
3. 如果本地缓存命中，异步更新远程缓存
4. 如果两级缓存都未命中，执行原方法并将结果写入两级缓存

#### 3.1.3 LOCAL_ONLY (仅本地)
1. 只查询和更新本地缓存
2. 适用于单实例应用或对一致性要求不高的场景

#### 3.1.4 REMOTE_ONLY (仅远程)
1. 只查询和更新远程缓存
2. 适用于需要强一致性的分布式应用

### 3.2 缓存注解

#### 3.2.1 @TieredCache
用于标记需要分层缓存的方法，支持复杂的缓存配置。

#### 3.2.2 @LocalCache
用于标记只需要本地缓存的方法。

#### 3.2.3 @RemoteCache
用于标记只需要远程缓存的方法。

#### 3.2.4 @CacheEvict
用于清除指定缓存项。

### 3.3 安全特性

#### 3.3.1 数据加密
支持对缓存数据进行 AES-256-GCM 加密，确保数据安全。

#### 3.3.2 访问控制
基于角色的访问控制（RBAC），防止未授权访问。

#### 3.3.3 缓存穿透防护
使用布隆过滤器和限流机制防止恶意请求穿透缓存。

### 3.4 监控运维

#### 3.4.1 指标统计
- 缓存命中率
- 平均响应时间
- 错误率统计

#### 3.4.2 健康检查
实时监控缓存连接状态和性能指标。

#### 3.4.3 性能监控
与 Micrometer 集成，支持多种监控系统。

## 4. 容错与降级机制

### 4.1 断路器模式
当远程缓存连续失败达到阈值时，自动打开断路器，避免雪崩效应。

### 4.2 优雅降级
当远程缓存不可用时，自动降级为仅本地缓存模式。

### 4.3 异常处理
所有缓存相关异常都不会影响主业务流程，确保系统稳定性。

## 5. 配置管理

### 5.1 基础配置
```yaml
tiered-cache:
  enabled: true
  local:
    provider: caffeine
    max-size: 10000
    expire-after-write: 300s
  remote:
    provider: redis
    cluster-nodes: localhost:6379
    ttl: 3600s
```

### 5.2 高级配置
支持详细的缓存策略、安全设置和监控配置。

## 6. 性能优化

### 6.1 异步处理
所有非关键路径的操作都采用异步方式执行，提高响应速度。

### 6.2 连接池
对远程缓存连接使用连接池管理，提高资源利用率。

### 6.3 批量操作
支持批量缓存操作，减少网络开销。

## 7. 测试策略

### 7.1 单元测试
覆盖所有核心功能和边界情况。

### 7.2 集成测试
验证与 Spring Boot 和各种缓存提供商的集成。

### 7.3 性能测试
确保在高并发场景下的性能表现。

## 8. 部署与运维

### 8.1 部署方式
支持传统部署和容器化部署。

### 8.2 监控集成
提供与主流监控系统的集成方案。

### 8.3 故障排查
提供详细的日志和诊断信息，便于问题排查。