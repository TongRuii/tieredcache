# ğŸ¯ TieredCache ä½¿ç”¨ç¤ºä¾‹æ¼”ç¤ºæ€»ç»“

## ğŸ“‹ æ¼”ç¤ºå†…å®¹æ¦‚è§ˆ

æˆ‘å·²ç»ä¸ºæ‚¨åˆ›å»ºäº†ä¸€ä¸ªå®Œæ•´çš„TieredCacheä½¿ç”¨ç¤ºä¾‹ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

### ğŸ—ï¸ **é¡¹ç›®ç»“æ„**

```
src/main/java/com/cache/plugin/example/demo/
â”œâ”€â”€ DemoApplication.java           # ä¸»å¯åŠ¨ç±»
â”œâ”€â”€ DemoRunner.java                # å‘½ä»¤è¡Œæ¼”ç¤ºè¿è¡Œå™¨
â”œâ”€â”€ config/
â”‚   â””â”€â”€ DemoConfiguration.java     # æ¼”ç¤ºé…ç½®ç±»
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ DemoController.java        # Web APIæ§åˆ¶å™¨
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ User.java                  # ç”¨æˆ·å®ä½“
â”‚   â”œâ”€â”€ UserProfile.java           # ç”¨æˆ·è¯¦æƒ…
â”‚   â”œâ”€â”€ Product.java               # äº§å“å®ä½“
â”‚   â””â”€â”€ Order.java                 # è®¢å•å®ä½“
â””â”€â”€ service/
    â”œâ”€â”€ UserService.java           # ç”¨æˆ·æœåŠ¡ (åˆ†å±‚ç¼“å­˜æ¼”ç¤º)
    â”œâ”€â”€ ProductService.java        # äº§å“æœåŠ¡ (ç­–ç•¥å¯¹æ¯”æ¼”ç¤º)
    â””â”€â”€ OrderService.java          # è®¢å•æœåŠ¡ (ç¼“å­˜æ¸…é™¤æ¼”ç¤º)
```

### ğŸ¨ **æ¼”ç¤ºåœºæ™¯**

#### 1. **ç”¨æˆ·ä¿¡æ¯ç®¡ç†** - åˆ†å±‚ç¼“å­˜ç­–ç•¥
```java
@TieredCache(
    local = @LocalCache(maxSize = 1000, expireAfterWrite = 300),
    remote = @RemoteCache(ttl = 3600),
    key = "'user:' + #userId",
    strategy = CacheStrategy.LOCAL_FIRST
)
public User getUserById(Long userId) { ... }
```

#### 2. **äº§å“ç›®å½•ç®¡ç†** - å¤šç§ç¼“å­˜ç­–ç•¥å¯¹æ¯”
- `LOCAL_FIRST`: æœ¬åœ°ä¼˜å…ˆï¼Œé€‚åˆé«˜é¢‘è®¿é—®
- `REMOTE_FIRST`: è¿œç¨‹ä¼˜å…ˆï¼Œé€‚åˆåˆ†å¸ƒå¼ä¸€è‡´æ€§
- `LOCAL_ONLY`: ä»…æœ¬åœ°ï¼Œé€‚åˆå•æœºé«˜æ€§èƒ½
- `REMOTE_ONLY`: ä»…è¿œç¨‹ï¼Œé€‚åˆæ•°æ®å…±äº«

#### 3. **è®¢å•å¤„ç†** - ç¼“å­˜æ¸…é™¤æœºåˆ¶
```java
@CacheEvict(key = "'order:' + #orderId")
public void updateOrderStatus(Long orderId, String newStatus) { ... }
```

#### 4. **æ€§èƒ½ä¼˜åŒ–** - ç¼“å­˜æ•ˆæœå¯¹æ¯”
- æ— ç¼“å­˜ vs æœ‰ç¼“å­˜çš„æ€§èƒ½å¯¹æ¯”
- ä¸åŒç¼“å­˜ç­–ç•¥çš„å“åº”æ—¶é—´å¯¹æ¯”
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡

### ğŸš€ **å¯åŠ¨æ–¹å¼**

#### æ–¹å¼ä¸€ï¼šä¸€é”®å¯åŠ¨è„šæœ¬
```bash
# Linux/Mac
./run-demo.sh

# Windows
run-demo.bat
```

#### æ–¹å¼äºŒï¼šå‘½ä»¤è¡Œæ¼”ç¤º
```bash
mvn exec:java -Dexec.mainClass="com.cache.plugin.example.demo.DemoApplication" -Dspring.profiles.active=demo
```

#### æ–¹å¼ä¸‰ï¼šWebæœåŠ¡æ¼”ç¤º
```bash
mvn spring-boot:run -Dspring.profiles.active=demo
# è®¿é—®: http://localhost:8080/api/demo/
```

### ğŸ¯ **æ ¸å¿ƒæ¼”ç¤ºåŠŸèƒ½**

#### 1. **åŸºç¡€ç¼“å­˜æ“ä½œ**
- âœ… æ•°æ®å­˜å‚¨å’Œè·å–
- âœ… ç¼“å­˜å‘½ä¸­å’Œæœªå‘½ä¸­
- âœ… è‡ªåŠ¨è¿‡æœŸæœºåˆ¶
- âœ… ç¼“å­˜å¤§å°é™åˆ¶

#### 2. **é«˜çº§ç¼“å­˜ç‰¹æ€§**
- âœ… åˆ†å±‚ç¼“å­˜æ¶æ„
- âœ… å¤šç§ç¼“å­˜ç­–ç•¥
- âœ… æ¡ä»¶ç¼“å­˜
- âœ… ç¼“å­˜æ¸…é™¤å’Œæ›´æ–°

#### 3. **æ€§èƒ½ä¼˜åŒ–**
- âœ… å“åº”æ—¶é—´å¯¹æ¯”
- âœ… ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- âœ… å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- âœ… å¹¶å‘è®¿é—®å¤„ç†

#### 4. **ç›‘æ§å’Œè¿ç»´**
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹
- âœ… ç¼“å­˜æŒ‡æ ‡ç›‘æ§
- âœ… æ€§èƒ½ç»Ÿè®¡
- âœ… é”™è¯¯å¤„ç†

### ğŸ“Š **Web API ç«¯ç‚¹**

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | ç¼“å­˜ç‰¹æ€§ |
|------|------|------|----------|
| `/api/demo/user/{id}` | GET | è·å–ç”¨æˆ·ä¿¡æ¯ | åˆ†å±‚ç¼“å­˜ |
| `/api/demo/user/{id}/profile` | GET | è·å–ç”¨æˆ·è¯¦æƒ… | æœ¬åœ°ç¼“å­˜ |
| `/api/demo/product/{id}` | GET | è·å–äº§å“ä¿¡æ¯ | è¿œç¨‹ä¼˜å…ˆ |
| `/api/demo/products/hot` | GET | è·å–çƒ­é—¨äº§å“ | é•¿æ—¶é—´ç¼“å­˜ |
| `/api/demo/order/{id}` | GET | è·å–è®¢å•ä¿¡æ¯ | åˆ†å±‚ç¼“å­˜ |
| `/api/demo/order/{id}/status` | PUT | æ›´æ–°è®¢å•çŠ¶æ€ | ç¼“å­˜æ¸…é™¤ |
| `/api/demo/performance` | GET | æ€§èƒ½å¯¹æ¯”æµ‹è¯• | æ€§èƒ½ç»Ÿè®¡ |
| `/api/demo/strategies` | GET | ç­–ç•¥å¯¹æ¯”æµ‹è¯• | ç­–ç•¥æ¼”ç¤º |

### ğŸ”§ **é…ç½®ç‰¹æ€§**

#### æ¼”ç¤ºç¯å¢ƒé…ç½® (`application-demo.yml`)
```yaml
tiered-cache:
  enabled: true
  local:
    provider: caffeine
    max-size: 10000
    expire-after-write: 300s
  remote:
    provider: redis
    enabled: false  # ä½¿ç”¨Mocké¿å…Redisä¾èµ–
  monitoring:
    metrics:
      enabled: true
```

#### Mocké…ç½®
- âœ… Mock RedisTemplate - æ— éœ€çœŸå®RedisæœåŠ¡å™¨
- âœ… SimpleMeterRegistry - æä¾›ç›‘æ§æŒ‡æ ‡
- âœ… å®Œæ•´çš„Spring Booté›†æˆ

### ğŸ“ˆ **æ¼”ç¤ºæ•ˆæœ**

#### æ€§èƒ½æå‡ç¤ºä¾‹
```
æ— ç¼“å­˜: 50æ¬¡è°ƒç”¨è€—æ—¶ 5000ms (å¹³å‡: 100ms/æ¬¡)
æœ‰ç¼“å­˜: 50æ¬¡è°ƒç”¨è€—æ—¶ 50ms (å¹³å‡: 1ms/æ¬¡)
æ€§èƒ½æå‡: 100å€
```

#### ç¼“å­˜ç­–ç•¥å¯¹æ¯”
```
LOCAL_FIRST:  é¦–æ¬¡ 120ms, åç»­ 1ms
REMOTE_FIRST: é¦–æ¬¡ 150ms, åç»­ 5ms  
LOCAL_ONLY:   é¦–æ¬¡ 100ms, åç»­ 1ms
REMOTE_ONLY:  é¦–æ¬¡ 130ms, åç»­ 8ms
```

### ğŸ“ **å­¦ä¹ ä»·å€¼**

#### 1. **å®é™…åº”ç”¨åœºæ™¯**
- ç”µå•†ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- äº§å“ç›®å½•ç¼“å­˜
- è®¢å•çŠ¶æ€ç®¡ç†
- çƒ­é—¨å†…å®¹æ¨è

#### 2. **æœ€ä½³å®è·µ**
- ç¼“å­˜é”®è®¾è®¡æ¨¡å¼
- è¿‡æœŸæ—¶é—´è®¾ç½®ç­–ç•¥
- ç¼“å­˜æ¸…é™¤æ—¶æœº
- æ€§èƒ½ç›‘æ§æ–¹æ³•

#### 3. **æ¶æ„è®¾è®¡**
- åˆ†å±‚ç¼“å­˜æ¶æ„
- ç­–ç•¥æ¨¡å¼åº”ç”¨
- AOPåˆ‡é¢ç¼–ç¨‹
- Spring Booté›†æˆ

### ğŸ” **ä»£ç äº®ç‚¹**

#### 1. **æ³¨è§£ä½¿ç”¨ç¤ºä¾‹**
```java
// åŸºç¡€åˆ†å±‚ç¼“å­˜
@TieredCache(local = @LocalCache(...), remote = @RemoteCache(...))

// æ¡ä»¶ç¼“å­˜
@TieredCache(condition = "#maxAge - #minAge <= 20")

// ç¼“å­˜æ¸…é™¤
@CacheEvict(key = "'order:' + #orderId")
```

#### 2. **Mockå®ç°**
- å®Œæ•´çš„RedisConnectionFactory Mock
- åŸºæœ¬çš„Redisæ“ä½œæ¨¡æ‹Ÿ
- æ— å¤–éƒ¨ä¾èµ–çš„æ¼”ç¤ºç¯å¢ƒ

#### 3. **æ€§èƒ½æµ‹è¯•**
- è‡ªåŠ¨åŒ–æ€§èƒ½å¯¹æ¯”
- å¤šç§åœºæ™¯æµ‹è¯•
- ç›´è§‚çš„ç»“æœå±•ç¤º

### ğŸ“š **æ‰©å±•å»ºè®®**

1. **æ·»åŠ æ›´å¤šç¼“å­˜æä¾›å•†**: Hazelcast, EhCacheç­‰
2. **é›†æˆçœŸå®Redis**: æ¼”ç¤ºåˆ†å¸ƒå¼ç¼“å­˜ç‰¹æ€§
3. **æ·»åŠ å‹åŠ›æµ‹è¯•**: å¹¶å‘è®¿é—®æ€§èƒ½æµ‹è¯•
4. **ç›‘æ§é¢æ¿**: å¯è§†åŒ–ç¼“å­˜æŒ‡æ ‡å±•ç¤º
5. **é…ç½®çƒ­æ›´æ–°**: åŠ¨æ€è°ƒæ•´ç¼“å­˜å‚æ•°

### ğŸ‰ **æ€»ç»“**

è¿™ä¸ªæ¼”ç¤ºåº”ç”¨å®Œæ•´å±•ç¤ºäº†TieredCacheçš„ï¼š
- âœ… **æ ¸å¿ƒåŠŸèƒ½**: åˆ†å±‚ç¼“å­˜ã€å¤šç§ç­–ç•¥ã€ç¼“å­˜æ¸…é™¤
- âœ… **æ€§èƒ½ä¼˜åŠ¿**: æ˜¾è‘—çš„å“åº”æ—¶é—´æå‡
- âœ… **æ˜“ç”¨æ€§**: ç®€å•çš„æ³¨è§£é…ç½®
- âœ… **çµæ´»æ€§**: å¤šç§ç¼“å­˜ç­–ç•¥å¯é€‰
- âœ… **ç›‘æ§æ€§**: å®Œæ•´çš„æŒ‡æ ‡å’Œå¥åº·æ£€æŸ¥
- âœ… **å®ç”¨æ€§**: çœŸå®ä¸šåŠ¡åœºæ™¯æ¼”ç¤º

é€šè¿‡è¿™ä¸ªæ¼”ç¤ºï¼Œç”¨æˆ·å¯ä»¥å¿«é€Ÿç†è§£å’Œä½“éªŒTieredCacheçš„å¼ºå¤§åŠŸèƒ½ï¼Œä¸ºå®é™…é¡¹ç›®åº”ç”¨æä¾›å‚è€ƒã€‚